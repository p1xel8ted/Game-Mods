# Summary - 03/02/2026

## Current Task
Fix TraitControl's "Protect Trait Count on Reroll" feature adding negative traits when "Replace Negative Traits" was enabled.

## Goal
Ensure that when protecting trait count during rerolls, any negative traits added are replaced with positive ones if the user has trait replacement enabled.

## Recent Changes Made

### TraitControl v0.1.5 - Protect Trait Count Fix

**Problem:**
When a follower with 8 traits was rerolled and got 3 positive traits, the "Protect Trait Count on Reroll" feature would add 5 more traits to restore the count to 8. However, these additional traits could be negative (Lustful, Unlawful, etc.) even when "Replace Negative Traits" was enabled.

**Root Cause:**
The protection logic called `SelectTrait()` to add traits until reaching the original count, but this happened *after* `ProcessTraitReplacement()` was called. The protection loop didn't filter for positive-only traits, and no second replacement pass was performed.

**Solution:**
After the protection loop adds traits, if `NoNegativeTraits` is enabled, call `ProcessTraitReplacement()` again to replace any negative traits that were added:

```csharp
// Re-apply trait replacement to handle any negative traits added by protection
if (Plugin.NoNegativeTraits.Value)
{
    NoNegativeTraits.ProcessTraitReplacement(brain);
}
```

Applied to both:
- `Reindoctrinate_Prefix` (reindoctrination at altar)
- `WrapReeducateRoutine` (reeducation trait reroll)

### TraitControl - Notification for Reindoctrination

**Feature:** Added trait reroll notification to reindoctrination (previously only showed for reeducation).

**Implementation:**
Added notification call at the end of `Reindoctrinate_Prefix`:
```csharp
if (Plugin.ShowNotificationOnTraitReroll.Value)
{
    NotificationCentre.Instance?.PlayGenericNotification(
        $"<color=#FFD201>{followerInfo.Name}</color>'s traits rerolled! ({oldTraitCount} → {newTraitCount})");
}
```

### TraitControl - Config Rename

**Change:** Renamed notification config for clarity since it now applies to both operations.

| Old Name | New Name |
|----------|----------|
| `ShowNotificationOnReeducateReroll` | `ShowNotificationOnTraitReroll` |
| "Show On Reeducate Reroll" | "Show On Trait Reroll" |

Updated description: "Show a notification when a follower's traits are rerolled via reeducation or reindoctrination."

## Files Modified

- `TraitControl/Patches/TraitWeights.cs` - Added post-protection trait replacement, added reindoctrinate notification, renamed config references
- `TraitControl/Configs.cs` - Renamed `ShowNotificationOnReeducateReroll` to `ShowNotificationOnTraitReroll`
- `TraitControl/Plugin.cs` - Updated config binding name and description
- `Thunderstore/traitcontrol/CHANGELOG.md` - Updated date to 03/02/2026, updated notification feature description

## Key Decisions

- Chose to re-run `ProcessTraitReplacement()` after protection rather than filtering source traits upfront. This reuses existing code and maintains consistency with how replacement works elsewhere.
- Used same config option for both reeducation and reindoctrination notifications since users who want one typically want both.

## Open Issues/Bugs
None currently known.

## Testing Notes
To verify the fix:
1. Enable "Replace Negative Traits" and "Protect Trait Count on Reroll"
2. Have a follower with many traits (e.g., 8)
3. Use Re-indoctrinate → should get all positive traits, count preserved
4. Check log for "After post-protection replacement" line showing only positive traits
